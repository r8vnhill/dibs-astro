stages:
    - test
    - build
    - deploy

variables:
    PNPM_STORE_DIR: .pnpm-store
    NODE_VERSION: "20"
    PNPM_VERSION: "9"
    GIT_DEPTH: "0"
    GIT_STRATEGY: clone
    GIT_CLEAN_FLAGS: -ffdx
    NODE_OPTIONS: --max-old-space-size=3072
    ASTRO_TELEMETRY_DISABLED: "1"

cache:
    key:
        files:
            - pnpm-lock.yaml
        prefix: pnpm-${CI_RUNNER_EXECUTABLE_ARCH}
    paths:
        - ${PNPM_STORE_DIR}

test:astro-check:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm config set store-dir ${PNPM_STORE_DIR}
        - pnpm install --frozen-lockfile
        - pnpm astro check

test:unit:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm config set store-dir ${PNPM_STORE_DIR}
        - pnpm install --frozen-lockfile
        - pnpm exec vitest run --config vitest.config.ts

test:astro-render:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm config set store-dir ${PNPM_STORE_DIR}
        - pnpm install --frozen-lockfile
        - pnpm exec vitest run --config vitest.astro.config.ts

build:
    stage: build
    image: node:${NODE_VERSION}-alpine
    variables:
        # Reduce presión de memoria en compilación Vite/Astro dentro del runner.
        UV_THREADPOOL_SIZE: "2"
    needs:
        - job: test:astro-check
        - job: test:unit
        - job: test:astro-render
    script:
        - apk add --no-cache git
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm config set store-dir ${PNPM_STORE_DIR}
        - pnpm install --frozen-lockfile
        - pnpm build
    artifacts:
        paths:
            - dist/
        expire_in: 1 week

deploy:
    stage: deploy
    image: node:${NODE_VERSION}-alpine
    needs:
        - job: test:astro-check
        - job: test:unit
        - job: test:astro-render
        - job: build
          artifacts: true
    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
          when: on_success
        - if: '$CI_COMMIT_TAG'
          when: manual
        - when: never
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm config set store-dir ${PNPM_STORE_DIR}
        - pnpm install --frozen-lockfile
        - pnpm exec wrangler deploy
    environment:
        name: production
