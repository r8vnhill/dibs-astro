stages:
    - test
    - build
    - deploy

variables:
    PNPM_CACHE_FOLDER: .pnpm-store
    NODE_VERSION: "20"
    PNPM_VERSION: "9"
    GIT_DEPTH: "0"

cache:
    key: pnpm-${CI_COMMIT_REF_SLUG}-${CI_RUNNER_EXECUTABLE_ARCH}
    paths:
        - ${PNPM_CACHE_FOLDER}

test:astro-check:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm install --frozen-lockfile
        - pnpm astro check

test:unit:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm install --frozen-lockfile
        - pnpm exec vitest run --config vitest.config.ts

test:astro-render:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm install --frozen-lockfile
        - pnpm exec vitest run --config vitest.astro.config.ts

build:
    stage: build
    image: node:${NODE_VERSION}-alpine
    needs:
        - job: test:astro-check
        - job: test:unit
        - job: test:astro-render
    script:
        - apk add --no-cache git
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm install --frozen-lockfile
        - pnpm build
    artifacts:
        paths:
            - dist/
        expire_in: 1 week

deploy:
    stage: deploy
    image: node:${NODE_VERSION}-alpine
    needs:
        - job: test:astro-check
        - job: test:unit
        - job: test:astro-render
        - job: build
          artifacts: true
    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
          when: on_success
        - if: '$CI_COMMIT_TAG'
          when: manual
        - when: never
    script:
        - corepack enable
        - corepack prepare pnpm@${PNPM_VERSION} --activate
        - pnpm install --frozen-lockfile
        - pnpm exec wrangler deploy
    environment:
        name: production
