---
/**
 * @file LessonMetaPanel.astro
 *
 * Renders structured metadata for a lesson page.
 *
 * This component is responsible for displaying:
 *
 * - Authorship information.
 * - Last modification date.
 * - A short list of recent changes (limited to the most recent 3).
 * - Optional commit links to the website repository across one or more platforms.
 *
 * ## Design Goals
 *
 * - Keep all data shaping in the frontmatter script section.
 * - Keep markup declarative and presentation-focused.
 * - Avoid hard-coded repository URLs inside the template.
 * - Gracefully handle untrusted `platforms` input.
 *
 * ## Responsibilities
 *
 * - Normalizes platform selection using {@link normalizePlatforms}.
 * - Builds commit URLs using {@link buildCommitUrl}.
 * - Formats ISO dates using {@link formatLessonDate}.
 * - Filters out unavailable platforms from {@link websiteRepoRefs}.
 */

import { getWebsiteRepoRef, WEBSITE_REPO_REFS } from "~/data/site";
import type { PartialRecord } from "~/types/records";
import {
    buildCommitUrl,
    normalizePlatforms,
    REPO_PLATFORM_LABEL,
    type RepoPlatform,
    type RepoRef,
} from "~/utils/git";
import { formatLessonDate, type LessonMetadataEntry } from "~/utils/lesson-metadata";
import { Mono } from "../ui/font";
import { Link } from "../ui/links";

interface Props {
    /**
     * Parsed lesson metadata for the current page.
     */
    metadata: LessonMetadataEntry;

    /**
     * Optional override for repository references used to build commit links.
     *
     * Allows:
     * - Testing with custom repos.
     * - Multi-site reuse.
     */
    websiteRepoRefs?: PartialRecord<RepoPlatform, RepoRef>;

    /**
     * Optional platform selection.
     *
     * May be:
     * - Undefined
     * - Invalid
     * - Duplicated
     * - Mixed with unsupported values
     *
     * Normalized through {@link normalizePlatforms}.
     */
    platforms?: unknown;
}

const {
    metadata,
    websiteRepoRefs = WEBSITE_REPO_REFS,
    platforms,
} = Astro.props as Props;

// ## Derived presentation values ##

// Join non-empty author names.
const authorsText = metadata.authors
    .map((author) => author.name.trim())
    .filter(Boolean)
    .join(", ");

// Format last modified date.
const lastModified = formatLessonDate(metadata.lastModified);

// Normalize and filter platforms.
const selectedPlatforms = normalizePlatforms(platforms);
const availablePlatforms = selectedPlatforms.filter(
    (platform) => Boolean(websiteRepoRefs[platform] ?? getWebsiteRepoRef(platform)),
);

// Precompute recent change entries for simpler markup.
const recentChanges = metadata.changes.slice(0, 3).map((change) => ({
    ...change,
    shortHash: change.hash.slice(0, 7),
    formattedDate: formatLessonDate(change.date),
    links: availablePlatforms.map((platform) => ({
        repoRef: websiteRepoRefs[platform] ?? getWebsiteRepoRef(platform),
        platform,
        label: REPO_PLATFORM_LABEL[platform],
    })).filter((link) => Boolean(link.repoRef)).map((link) => ({
        platform: link.platform,
        label: link.label,
        href: buildCommitUrl(link.repoRef!, link.platform, change.hash),
    })),
}));

const sectionHeadingId = "lesson-meta-heading";
const recentChangesHeadingId = "lesson-meta-recent-changes-heading";
---

<section
    aria-labelledby={sectionHeadingId}
    class:list={[
        "rounded-md",
        "border",
        "px-4",
        "py-3",
        "text-sm",
        "bg-base-elevated",
        "text-base-text",
        "border-base-border",
        "mt-3",
    ]}
>
    <h2
        id={sectionHeadingId} class="font-semibold"
        data-testid="panel-title"
    >
        Metadatos de la lección
    </h2>

    <dl class="space-y-1">
        <div>
            <dt class="font-semibold inline">Autoría:</dt>
            <dd class="inline ml-1" data-testid="authors-value">
                {authorsText || "sin autoría registrada"}
            </dd>
        </div>
        <div>
            <dt class="font-semibold inline">
                Última actualización:
            </dt>
            <dd class="inline ml-1" data-testid="last-updated-value">{lastModified}</dd>
        </div>
    </dl>

    <div class="mt-2">
        <h3 id={recentChangesHeadingId} class="font-semibold">
            Cambios recientes:
        </h3>

        {
            recentChanges.length > 0 ? (
                <ul class="list-disc list-inside mt-1" data-testid="changes-list">
                    {
                        recentChanges.map((change) => (
                            <li>
                                <Mono>{change.shortHash}</Mono>
                                {" · "}
                                {change.formattedDate}
                                {" · "}
                                {change.subject}
                                {
                                    change.links.length > 0 && (
                                        <span class="ml-1">
                                            (
                                            {
                                                change.links.map(
                                                    (link, index) => (
                                                    <Fragment>
                                                        {index > 0 && " / "}
                                                        <Link href={link.href}>{link.label}</Link>
                                                    </Fragment>
                                                ),
                                                )
                                            }
                                            )
                                        </span>
                                    )
                                }
                            </li>
                        ))
                    }
                </ul>
            ) : (
                <p class="mt-1" data-testid="changes-empty">
                    No hay cambios registrados.
                </p>
            )
        }
    </div>
</section>
