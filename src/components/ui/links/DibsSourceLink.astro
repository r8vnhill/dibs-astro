---
import Link from "./Link.astro";

type Props = {
    /** Nombre corto del repositorio sin prefijo `dibs-`. */
    repo: string;
    /** Ruta del archivo dentro del repositorio. */
    file: string;
    /** Texto opcional a mostrar en el enlace. */
    title?: string;
    /** Commit hash, tag o nombre de branch (opcional). */
    ref?: string;
    /** Número de línea inicial opcional para anclar al archivo en GitLab. */
    line?: number;
    /** Línea final opcional (usa un rango Lx-Ly). */
    endLine?: number;
};

const { repo, file, title, ref, line, endLine }: Props = Astro.props;

// Si no se especifica ref, apunta a la rama main
const resolvedRef = ref ?? "main";
const isExplicitRef = resolvedRef !== "main";

// Heurística simple: ¿parece hash de commit?
const looksLikeCommit = /^[0-9a-f]{7,40}$/i.test(resolvedRef);
const shortRef = looksLikeCommit ? resolvedRef.slice(0, 7) : resolvedRef;

// GitLab usa `-/blob/<ref>/<file>` para cualquier referencia
const startLine = typeof line === "number" && Number.isFinite(line)
    ? Math.max(1, Math.floor(line))
    : undefined;
const rawEndLine = typeof endLine === "number" && Number.isFinite(endLine)
    ? Math.max(1, Math.floor(endLine))
    : undefined;
const resolvedEndLine =
    startLine !== undefined && rawEndLine !== undefined && rawEndLine >= startLine
        ? rawEndLine
        : undefined;
const lineFragment = startLine !== undefined
    ? `#L${startLine}${resolvedEndLine ? `-${resolvedEndLine}` : ""}`
    : "";

const hrefBase = `https://gitlab.com/r8vnhill/dibs-${repo}/-/blob/${resolvedRef}/${file}`;
const href = `${hrefBase}${lineFragment}`;

const lineLabel = startLine !== undefined
    ? resolvedEndLine
        ? `, líneas ${startLine}-${resolvedEndLine}`
        : `, línea ${startLine}`
    : "";
const ariaLabel = `Fuente (${isExplicitRef ? resolvedRef : "main"}${lineLabel})`;
---

<Link
    {href} class:list={["dibs-source-link"]}
    data-has-ref={isExplicitRef ? "true" : "false"} aria-label={ariaLabel}
><slot>{title ?? `${repo}/${file}`}</slot></Link><a {href} class:list={["dibs-source-link"]}>{
    isExplicitRef && <small class="ref-hint" aria-hidden="true">{shortRef}</small>
}</a>

<style>
    .dibs-source-link {
        display: inline-flex;
        align-items: baseline;
        gap: 0.4rem;
        text-decoration-line: underline;
        text-underline-offset: 2px;
        text-decoration-thickness: 1px;
    }

    /* Subrayado sutil: sólido si es main, punteado si hay ref explícita */
    .dibs-source-link[data-has-ref="false"] {
        text-decoration-style: solid;
    }
    .dibs-source-link[data-has-ref="true"] {
        text-decoration-style: dotted;
    }

    /* Mini hint monoespaciado, con colores derivados del primary */
    .ref-hint {
        font:
            0.75em ui-monospace,
            SFMono-Regular,
            Menlo,
            Monaco,
            Consolas,
            "Liberation Mono",
            monospace;
        line-height: 1;
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;

        /* Usa tokens derivados del primary (adaptan a light/dark) */
        color: var(--color-primary-darker);
        background: var(--color-primary-lightest);
        border: 1px solid var(--color-primary-light);
        opacity: 0.9;
    }

    /* Hover/Focus: incrementar apenas el contraste, sin gritar */
    .dibs-source-link:hover .ref-hint,
    .dibs-source-link:focus-visible .ref-hint {
        color: var(--color-primary-darkest);
        border-color: var(--color-primary);
    }
</style>
