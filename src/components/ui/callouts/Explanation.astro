---
import * as Icons from "~/assets/img/icons";
import CalloutHeading from "./CalloutHeading.astro";
import type { BaseCalloutProps } from "./shared";

type ExplanationProps = BaseCalloutProps;

/* -------------------- Resolve props & defaults -------------------- */
const {
    title = "Detalles clave",
    icon: Icon = Icons.ChatCircleText,
    headingLevel = "h3",
    headingId,
    class: className = "",
    headingClass = "",
    iconClass = "",
    ariaLabel,
    compact = false,
    prose = true,
    // Any other attributes will be filtered and forwarded to <section>
    ...rest
} = Astro.props as ExplanationProps & Record<string, any>;

const resolvedHeadingId = headingId ?? `explanation-${crypto.randomUUID()}`;

/**
 * Forward only safe/expected attributes to the <section> (e.g., id, data-*, aria-*).
 * This keeps the component flexible without opening it to accidental attribute leakage.
 */
const passthrough = Object.fromEntries(
    Object.entries(rest).filter(
        ([k]) => k === "id" || k.startsWith("data-") || k.startsWith("aria-"),
    ),
);
---

<section
    class:list={[
        "explanation relative rounded-md shadow-sm",
        compact ? "px-4 py-3" : "px-5 py-4",
        className,
    ]}
    style={{
        // Pass resolved colors down to the child heading through CSS variables.
        "--callout-title-color": "var(--explanation__title-color)",
        "--callout-icon-color": "var(--explanation__title-color)",
    }}
    role="region" aria-labelledby={resolvedHeadingId}
    {...ariaLabel ? { "aria-label": ariaLabel } : {}} {...passthrough}
>
    <!-- Heading row (icon + title). -->
    <CalloutHeading
        {Icon} heading={title}
        {headingLevel} headingId={resolvedHeadingId}
        class={`explanation__title text-explanation-title ${headingClass}`} iconClass={`explanation__icon ${iconClass}`}
    >
        <slot name="title">{title}</slot>
    </CalloutHeading>

    <!-- Body content. Enable `prose` when you want Typography styles. -->
    <div
        class:list={[
            "explanation__body",
            prose
            && "prose prose-neutral dark:prose-invert max-w-none prose-p:my-0 prose-p:leading-relaxed",
            "[&_.listitem__icon]:text-explanation-title",
        ]}
    >
        <slot />
    </div>
</section>

<style scoped>
    /* ------------------------------------------------------------
       Local defaults for the explanation color tokens.
       Override these globally in your theme to align with your palette.
       ------------------------------------------------------------ */

    /* ------------------------------------------------------------
       Base container styles (left border accent)
       ------------------------------------------------------------ */
    .explanation {
        padding: 1rem 1.25rem;
        border-radius: 0.375rem;
        margin: 1rem 0;
        background-color: var(--explanation__bg-color);
        border-left: 4px solid var(--explanation__border-color);
    }

    /* explanation:
       The rule below assumes you define *-dark variables globally (e.g., in a tokens.css).
       If you rely entirely on :root.dark overrides above, you can remove this block. */
    :global([data-theme="dark"]) :where(.explanation) {
        background-color: var(--explanation__bg-color-dark);
        border-left-color: var(--explanation__border-color-dark);
    }

    /* ------------------------------------------------------------
       Body rhythm adjustments
       ------------------------------------------------------------ */
    .explanation__body :where(p:first-child) {
        margin-top: 0;
    }
    .explanation__body :where(p:last-child) {
        margin-bottom: 0;
    }

    .explanation__body :where(.listitem__icon) {
        color: var(--explanation__title-color);
    }
</style>
