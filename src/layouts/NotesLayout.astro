---
/**
 * @file NotesLayout.astro
 *
 * Page layout for lesson content under `src/pages/notes/**`.
 *
 * This layout composes the main “lesson” experience:
 *
 * - A persistent course sidebar (tree navigation) built from `courseStructure`.
 * - The lesson header (title + reading time estimate).
 * - Optional lesson metadata panels (authors, last modified, recent changes, repo links).
 * - The lesson body via the default `<slot />`.
 * - Previous/next navigation controls (manual overrides or auto-resolved).
 *
 * ## Data sources
 *
 * - **Sidebar lessons:** `courseStructure` (static course definition).
 * - **Auto navigation:** {@link resolveAutoNav} uses `courseStructure` and current pathname.
 * - **Lesson metadata:** {@link resolveLessonMetadata} uses the generated metadata dataset (see
 *   `src/data/lesson-metadata.generated.json`).
 *
 * ## Navigation precedence
 *
 * Previous/next links may be provided by the page frontmatter and/or derived from the course
 * structure. Resolution follows this precedence:
 *
 * 1. Explicit `previous`/`next` props (frontmatter override)
 * 2. Auto navigation from {@link resolveAutoNav}
 * 3. Omit navigation button when neither is available
 *
 * Links are normalized by {@link normalizeNavigation} to ensure consistent routing (e.g. trailing
 * slashes and collapsed separators).
 *
 * ## Accessibility
 *
 * - Sidebar is wrapped in `<aside>` with an explicit `aria-label`.
 * - Prev/next controls are wrapped in `<nav>` with an `aria-label`.
 * - When there is no “previous” button, a hidden placeholder is used on wide screens to
 *   preserve alignment without adding noise to assistive technologies.
 */
import * as icons from "~/assets/img/icons";
import LessonSidebar from "~/components/navigation/LessonSidebar";
import NavigationButton from "~/components/navigation/NavigationButton.astro";
import LessonMetaPanel from "~/components/notes/LessonMetaPanel.astro";
import LessonRepoPanel from "~/components/notes/LessonRepoPanel.astro";
import ReadingTime from "~/components/reading-time/ReadingTime.astro";
import { courseStructure } from "~/data/course-structure";
import BaseLayout from "~/layouts/BaseLayout.astro";
import { normalizeNavigation, resolveAutoNav } from "~/utils";
import type { RepoRef } from "~/utils/git";
import { resolveLessonMetadata } from "~/utils/lesson-metadata";
import type { PageMeta } from "~/utils/page-meta";

/**
 * Props passed to the layout.
 *
 * Lesson pages typically set these values from frontmatter.
 */
interface Props {
    /**
     * Title of the current lesson.
     *
     * Rendered as the `<h1>` and used as the page title within {@link BaseLayout}.
     */
    title: string;

    /**
     * Short lesson description for SEO and social previews.
     *
     * Forwarded to {@link BaseLayout}.
     */
    description?: string;

    /**
     * Optional next lesson navigation override.
     *
     * If omitted, the layout attempts to auto-resolve it from the course structure.
     */
    next?: { title: string; href: string };

    /**
     * Optional previous lesson navigation override.
     *
     * If omitted, the layout attempts to auto-resolve it from the course structure.
     */
    previous?: { title: string; href: string };

    /**
     * Multiplier applied to the reading-time estimate.
     *
     * Useful to tune reading-time estimates for lessons that include code, exercises, or dense
     * theoretical sections.
     */
    timeMultiplier?: number;

    /**
     * Optional repository information for the lesson.
     *
     * When provided, the layout renders repository links via {@link LessonRepoPanel}.
     */
    git?: RepoRef;
}

// Extract current page data and resolve metadata/navigation.
const { title, next, previous, timeMultiplier, git, description } = Astro.props as Props;
const pathname = Astro.url.pathname;

// Metadata may be absent if the route is not present in the generated dataset.
const lessonMetadata = resolveLessonMetadata(pathname);
const lessonPageMeta = lessonMetadata
    ? {
        authors: lessonMetadata.authors.map((author) => ({
            name: author.name,
            ...(author.url ? { url: author.url } : {}),
        })),
        changes: lessonMetadata.changes,
        ...(lessonMetadata.lastModified
            ? { lastModified: lessonMetadata.lastModified }
            : {}),
    }
    : {};

const pageMeta: PageMeta = {
    type: "website",
    canonicalUrl: Astro.url.href,
    language: "es",
    ...lessonPageMeta,
};

// Attempt to auto-resolve previous/next from course structure.
const autoNav = resolveAutoNav(pathname, courseStructure);

// Allow manual override from frontmatter (if provided).
const effectivePrevious = previous ?? autoNav.previous ?? undefined;
const effectiveNext = next ?? autoNav.next ?? undefined;

// Normalize hrefs for consistency (e.g. ensure trailing slashes).
const { normalizedNext, normalizedPrevious } = normalizeNavigation(
    effectiveNext,
    effectivePrevious,
);
---

<BaseLayout
    pageTitle={title} {...(description !== undefined ? { description } : {})}
    {pageMeta}
>
    <div class="flex">
        <!-- Sidebar with course structure navigation -->
        <LessonSidebar client:load lessons={courseStructure} />

        <!-- Main content area -->
        <div
            id="lesson-content"
            class:list={["flex-1", "px-4", "md:px-8", "max-w-screen-xl", "mx-auto"]}
        >
            <h1 class:list={["text-2xl sm:text-3xl"]}>{title}</h1>

            <ReadingTime multiplier={timeMultiplier ?? 1.5} />

            {lessonMetadata && <LessonMetaPanel metadata={lessonMetadata} />}

            {git && <LessonRepoPanel {git} />}

            <slot />

            {
                (normalizedNext || normalizedPrevious) && (
                    <nav
                        aria-label="Siguiente o anterior lección"
                        class:list={[
                            "mt-12",
                            "flex",
                            "flex-col",
                            "sm:flex-row",
                            "justify-between",
                            "gap-4",
                            "border-t",
                            "border-base-border",
                            "pt-6",
                        ]}
                    >
                        {
                            normalizedPrevious ? (
                                <NavigationButton
                                    href={normalizedPrevious.href} label={normalizedPrevious.title}
                                    iconPosition="left"
                                >
                                    <icons.ArrowLeft class="w-5 h-5" slot="icon" />
                                </NavigationButton>
                            ) : <div aria-hidden="true" class="hidden sm:block" />
                        }

                        {
                            normalizedNext && (
                                <NavigationButton
                                    href={normalizedNext.href} label={normalizedNext.title}
                                    iconPosition="right"
                                >
                                    <icons.ArrowRight class="w-5 h-5" slot="icon" />
                                </NavigationButton>
                            )
                        }
                    </nav>
                )
            }
        </div>
    </div>
</BaseLayout>

<style is:global>
    /**
     * Sidebar tree styles.
     *
     * These are global because the sidebar is rendered as a nested tree and the layout is
     * responsible for the overall page chrome.
     *
     * If these styles grow further, consider moving them into the sidebar component (or a
     * dedicated stylesheet) to keep this layout focused on composition.
     */
    .lesson-tree ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .lesson-tree li {
        position: relative;
        line-height: 1.3;
    }

    .lesson-tree a {
        display: inline-block;
        padding: 2px 0;
    }

    /* Highlight current page in sidebar */
    .lesson-tree a.text-primary {
        position: relative;
    }

    .lesson-tree a.text-primary::before {
        content: "";
        position: absolute;
        left: -0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: var(--color-primary);
        border-radius: 2px;
    }

    /* Tree “connector” line */
    .lesson-tree li::before {
        content: "";
        position: absolute;
        top: 0.75rem;
        left: 0.5rem;
        width: 1px;
        height: 100%;
        background-color: var(--color-base-border);
        opacity: 0.5;
    }

    .lesson-tree li:last-child::before {
        height: 0.8rem;
    }

    /* Indentation for grouped subtrees */
    .lesson-tree .group {
        padding-left: 0.75rem; /* extra space for the tree line */
    }

    /* Visual separator between major groups */
    .lesson-tree .tree-separator {
        border-top: 1px solid var(--color-base-border);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
    }
</style>
