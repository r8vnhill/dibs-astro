---
/**
 * @file BaseLayout.astro
 *
 * Root layout for all pages in the DIBS site.
 *
 * This component defines the global HTML skeleton and shared UI structure. All content pages are
 * rendered inside the `<slot />` of this layout.
 *
 * ## Responsibilities
 *
 * - Defines the `<html>`, `<head>`, and `<body>` structure.
 * - Delegates SEO and metadata generation to the {@link Head} component.
 * - Applies the persisted theme class early to prevent FOUC (Flash Of Unstyled Content).
 * - Loads global styles (Tailwind + CSS variables).
 * - Renders site-wide {@link Header} and {@link Footer}.
 * - Provides accessibility features (skip link).
 *
 * ## Design principles
 *
 * - Keep layout logic minimal and declarative.
 * - Avoid business logic here â€” only presentation and global concerns.
 * - Centralize metadata and language decisions.
 * - Fail gracefully in restricted environments (e.g. disabled `localStorage`).
 */
import Footer from "~/components/Footer.astro";
import Header from "~/components/header/Header.astro";
import Head from "~/components/meta/Head.astro";
import { getWebsiteRepoRef } from "~/data/site";
import "~/styles/global.css"; // Tailwind + CSS variables
import { site } from "~/utils";
import type { PageMeta } from "~/utils/page-meta";

/**
 * Props accepted by the layout.
 */
type Props = {
    /**
     * Page-specific title.
     *
     * This value is combined with {@link site.SHORT_TITLE} to generate the final `<title>`.
     */
    pageTitle: string;

    /**
     * Optional meta description.
     *
     * Passed directly to the {@link Head} component.
     */
    description?: string;

    /**
     * Optional structured page metadata.
     *
     * Used to generate canonical URLs, JSON-LD, and citation metadata.
     */
    pageMeta?: PageMeta;

    /**
     * Optional document language (BCP 47 tag).
     *
     * If omitted, falls back to:
     *   1. `pageMeta.language`
     *   2. `"es"`
     */
    lang?: string;
};

// Props passed into the layout
const { pageTitle, description, pageMeta, lang } = Astro.props as Props;

const githubRef = getWebsiteRepoRef("github");
const gitlabRef = getWebsiteRepoRef("gitlab");

const githubRepoInfo = githubRef
    ? {
        username: githubRef.user,
        repo: githubRef.repo,
    }
    : undefined;

const gitlabRepoInfo = gitlabRef
    ? {
        username: gitlabRef.user,
        repo: gitlabRef.repo,
    }
    : undefined;

/**
 * Full page title used in the `<title>` tag.
 *
 * Format:
 *     <Page Title> | <Site Short Title>
 */
const fullTitle = `${pageTitle} | ${site.SHORT_TITLE}`;

/**
 * Determines the `<html lang="...">` attribute.
 *
 * Priority:
 *   1. Explicit `lang` prop
 *   2. `pageMeta.language`
 *   3. Default "es"
 *
 * Always trimmed and guaranteed non-empty.
 */
const documentLang = (lang ?? pageMeta?.language ?? "es").trim() || "es";

/**
 * Props passed to the {@link Head} component.
 *
 * `description` and `pageMeta` are only included if defined, to avoid leaking unnecessary
 * `undefined` values.
 */
const headProps = {
    title: fullTitle,
    url: Astro.url.href,
    ...(description !== undefined ? { description } : {}),
    ...(pageMeta !== undefined ? { pageMeta } : {}),
};

const headerProps = {
    title: site.SHORT_TITLE,
    ...(gitlabRepoInfo ? { gitlab: gitlabRepoInfo } : {}),
    ...(githubRepoInfo ? { github: githubRepoInfo } : {}),
};
---

<!--
    Theme bootstrap script.

    Runs before styles load to prevent FOUC (Flash Of Unstyled Content).

    ## Behavior:

    - Reads the persisted "theme" value from localStorage.
    - Supports "dark" and "auto".
    - Falls back to system preference if storage access fails.
    - Applies the "dark" class to <html> accordingly.

    `is:inline` ensures:
    - The script is embedded directly in the HTML.
    - It executes immediately without hydration.
-->
<script is:inline>
    (() => {
        const DARK = "dark";
        const AUTO = "auto";

        try {
            const theme = localStorage.getItem("theme");

            const prefersDark = typeof window.matchMedia === "function"
                && window.matchMedia("(prefers-color-scheme: dark)").matches;

            const isDark = theme === DARK || (theme === AUTO && prefersDark);

            document.documentElement.classList.toggle(DARK, isDark);
        } catch {
            // localStorage may be blocked (privacy mode, sandboxed env, etc.)
            const prefersDark = typeof window.matchMedia === "function"
                && window.matchMedia("(prefers-color-scheme: dark)").matches;

            document.documentElement.classList.toggle(DARK, prefersDark);
        }
    })();
</script>

<html lang={documentLang}>
    <head>
        <!--
            Delegates:
            - <title>
            - meta description
            - canonical URL
            - JSON-LD (if article)
            - favicons
        -->
        <Head {...headProps} />

        <!--
            Informs the browser that both light and dark color schemes are supported.
            Helps native UI controls match the current theme.
        -->
        <meta name="color-scheme" content="light dark" />
    </head>

    <body class="min-h-screen bg-base-background text-base-text">
        <!--
            Accessibility: Skip link.
            Allows keyboard users to jump directly to main content.
        -->
        <a
            href="#main-content"
            class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 z-50 rounded bg-base-background px-3 py-2"
        >
            Saltar al contenido principal
        </a>

        <!--
            Global site header.
            Includes title and repository links.
        -->
        <Header {...headerProps} />

        <!--
            Main content container.
            Padding-top accounts for fixed header spacing.
        -->
        <main id="main-content" class="w-full pt-16">
            <slot />
        </main>

        <!-- Global footer -->
        <Footer />
    </body>
</html>
